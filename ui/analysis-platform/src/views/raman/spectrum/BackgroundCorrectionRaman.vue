<template>
  <div class="wrapper">
    <vue-sidebar>
      <h5>Controls</h5>
      <hr>
      <return-button routername="Raman"></return-button>
      <save-results-button routername="Raman"></save-results-button>
      <hr>
      <h5>Analysis Controls</h5>
      <hr>
      <div>
        <vue-number-input v-model="constantValue" :step="0.01" :min="0" :max="1" inline @change="updatePlot"></vue-number-input>
      </div>
      <div>
        <vue-number-input v-model="detailValue" :step="0.01" :min="0" :max="20" @change="updatePlot"></vue-number-input>
      </div>
    </vue-sidebar>
    <graph-area ref="area"></graph-area>
  </div>
</template>

<script>

import axios from "axios"
import Plotly from 'plotly.js-dist'

import VueNumberInput from '@chenfengyuan/vue-number-input'
import lib from "@/assets/js/raman/raman.js"

export default {

  props: ['inputData'],

  components: {
    VueNumberInput
  },

  data: function() {
    return {

      constantValue: 0.1,
      detailValue: 10,

      filePath: "",
      fileData: {},

      config: {},

      background: [],
      correctedSpectrum: [],

      xData:[100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,894,895,896,897,898,899],

      yData:[-0.00076184,-0.00111773,0.00338214,-0.0008693,0.00013118,0.00018106,0.00212105,0.00287755,0.00331903,0.00161223,0.0006936,0.00228632,0.00017088,-0.00071983,-0.00113903,0.00122526,0.00093392,0.00103624,0.00254137,0.00025059,-0.00060699,0.00326542,0.00312046,-0.00107575,0.00037176,0.00014574,0.00263673,0.00292622,-0.00063585,0.00156163,-0.00093321,0.00297575,0.0010868,0.00149128,-0.00085381,0.0009285,-0.00045683,0.00206685,0.00011514,-0.00066713,2.44e-05,0.00199623,0.00358893,0.00383158,0.00386228,0.00332873,0.00121506,0.00336153,0.0016481,-0.00019849,0.00409684,-0.00025304,0.00255273,0.00117988,0.0027367,0.00061304,0.00304251,0.00211982,0.00135786,0.00105477,0.00397535,0.0044331,0.00328836,0.00330512,0.00293992,0.00401032,0.00221504,0.00310388,0.00025338,0.00466507,0.00466157,0.00476307,0.00295428,0.00246549,0.00231454,0.00213437,0.00150663,0.00399976,0.0017629,0.00275399,0.00256276,0.00564396,0.00615612,0.00332927,0.00146011,0.00443283,0.00458608,0.00332442,0.00286772,0.00504291,0.00549556,0.00342515,0.00696241,0.00403682,0.00638069,0.00475204,0.00698178,0.00390184,0.00447837,0.00340068,0.00731534,0.0036408,0.00734071,0.00414678,0.00489047,0.00636199,0.00711959,0.00914779,0.009255,0.00579906,0.00831657,0.00864521,0.01024032,0.00849445,0.01097733,0.01073305,0.01099199,0.01047379,0.01383502,0.01149978,0.01503586,0.01495469,0.01279619,0.01313971,0.01552252,0.01439959,0.01947177,0.020457,0.01730162,0.01839186,0.02310961,0.02059706,0.02290221,0.02388299,0.0254641,0.02885416,0.03449378,0.03456763,0.03611775,0.04172778,0.04442787,0.04599641,0.05010619,0.05593176,0.0619775,0.0638426,0.07025454,0.07487436,0.07842004,0.08400875,0.08669724,0.08978286,0.09068195,0.08973087,0.09394468,0.08805305,0.08599475,0.08671334,0.08195737,0.08201356,0.07977817,0.07508764,0.07489203,0.07063895,0.07225104,0.06964779,0.07053631,0.07049452,0.0689185,0.07106955,0.06970061,0.07486474,0.07518312,0.07395953,0.07304864,0.07026872,0.07070276,0.06880506,0.06626287,0.06642876,0.06360648,0.0638316,0.05969266,0.05805516,0.05442484,0.0499382,0.04605407,0.04363084,0.03938572,0.03825417,0.03600641,0.03367411,0.03152677,0.03043197,0.02957637,0.02826824,0.02685961,0.02720985,0.02648494,0.02407021,0.02263107,0.02216542,0.02280456,0.01783145,0.01878755,0.01737216,0.01627971,0.019106,0.01833212,0.01806796,0.01853265,0.01959592,0.01660358,0.01940415,0.01984459,0.01799804,0.01695475,0.0203815,0.01934216,0.0220357,0.02329564,0.02280947,0.02291266,0.02454909,0.0244186,0.02263383,0.0240145,0.02422186,0.0225049,0.0219568,0.01810217,0.01733416,0.01847685,0.01751499,0.01803495,0.01330323,0.01581396,0.01165297,0.00975198,0.01157442,0.01255985,0.00986803,0.00818895,0.00842857,0.00677768,0.00616831,0.00934358,0.00607349,0.00843844,0.00827946,0.00461711,0.00812427,0.00563098,0.00418555,0.00499264,0.00438742,0.00596015,0.00659662,0.00595882,0.00713828,0.00738773,0.00459522,0.00254317,0.00431058,0.00294269,0.00541685,0.00480236,0.00337968,0.00680771,0.00291472,0.00342523,0.00275002,0.0043817,0.0056688,0.00636832,0.00509201,0.00366403,0.00445865,0.00540113,0.00410283,0.00560406,0.00481741,0.00357598,0.00208025,0.00238617,0.00211541,0.00610786,0.00184156,0.00158164,0.00193979,0.00581024,0.00308233,0.00587844,0.0049939,0.00526903,0.0023452,0.00230948,0.00223248,0.00335176,0.00555453,0.00372879,0.00323897,0.00433367,0.00490114,0.00390492,0.00636365,0.0054065,0.0053611,0.00428218,0.00498174,0.00658398,0.00552174,0.00505168,0.00308059,0.00334932,0.00337335,0.00243368,0.00367998,0.00549467,0.00307957,0.006475,0.00739268,0.00311072,0.00376871,0.0060457,0.0071546,0.0057826,0.00347642,0.00561514,0.00763937,0.00846047,0.00516934,0.00684092,0.00539095,0.00722031,0.00598439,0.00717677,0.00677775,0.00508343,0.0061485,0.00765906,0.0074155,0.00669803,0.00674578,0.01155017,0.00854857,0.01140799,0.00946436,0.00972926,0.01219694,0.00956959,0.01120814,0.01483382,0.01595107,0.0171459,0.01684474,0.01428292,0.0170535,0.01866728,0.02029042,0.02063294,0.02339964,0.02335014,0.02761322,0.02650552,0.0303927,0.03032129,0.03231378,0.03544804,0.03935612,0.04213476,0.0432884,0.04961656,0.04821043,0.05371744,0.05498323,0.05582639,0.06198062,0.06330671,0.06207308,0.06267246,0.05931924,0.05692432,0.05953764,0.05591826,0.053963,0.05053129,0.04531096,0.04620697,0.03973104,0.04076552,0.03940109,0.03279413,0.03206795,0.03084437,0.02890638,0.02897857,0.02740318,0.0246202,0.0235841,0.02569159,0.02159653,0.02260447,0.02284997,0.02209172,0.02416684,0.02000029,0.02149885,0.02361102,0.02149272,0.02037152,0.02175493,0.02520741,0.0224914,0.02567214,0.02670206,0.02688186,0.025101,0.0288131,0.02930065,0.02792354,0.03325799,0.03262939,0.03515566,0.03547636,0.03497861,0.04003812,0.03812632,0.03816155,0.0407419,0.0449163,0.04620152,0.0469894,0.04836119,0.04918954,0.04821877,0.05048422,0.05006681,0.05423733,0.05334132,0.05633393,0.06033219,0.06299885,0.06811541,0.07403334,0.07558319,0.08191378,0.0870501,0.09404977,0.09579257,0.09942716,0.09871621,0.09992824,0.09592021,0.09234983,0.08859965,0.08355792,0.07640139,0.07244121,0.06626851,0.05975248,0.05721754,0.05038135,0.0473185,0.04242503,0.04021271,0.03910641,0.03665252,0.03136834,0.03278997,0.02896635,0.02571757,0.02710419,0.02378695,0.02427133,0.02192814,0.01987653,0.02121853,0.01871067,0.01781212,0.01683354,0.01819025,0.01945981,0.01729981,0.01850884,0.02002987,0.01950573,0.01753572,0.02026398,0.01767677,0.019191,0.0165358,0.02104868,0.02177074,0.02104473,0.01955004,0.02056417,0.0200817,0.0194431,0.01891701,0.01902295,0.02132974,0.02315112,0.01907935,0.02323635,0.01825527,0.0195415,0.01963818,0.01995022,0.01652467,0.02018618,0.01825207,0.01823671,0.01855072,0.01901216,0.01673098,0.01747497,0.01447169,0.01803062,0.01684965,0.01511331,0.01619482,0.01729613,0.01603223,0.01535061,0.0149852,0.01837719,0.01530818,0.01521593,0.01725187,0.01730191,0.02040892,0.02015516,0.0213899,0.02056305,0.02286119,0.02597744,0.02741011,0.03122188,0.0325432,0.03501343,0.0353065,0.03955541,0.04264114,0.04642325,0.05176155,0.05742715,0.05956308,0.06444333,0.07217107,0.07397351,0.07794418,0.0847972,0.08524882,0.08560801,0.08611494,0.08194676,0.07885023,0.07672545,0.0694495,0.06694833,0.05913582,0.05486114,0.05086081,0.04800749,0.04021506,0.0377604,0.03562341,0.03072739,0.03086408,0.02915283,0.02567681,0.02376324,0.02329346,0.02215919,0.01916779,0.01781254,0.01593325,0.01874969,0.01652767,0.01579452,0.01215504,0.0156253,0.01238225,0.01219362,0.01231725,0.01007243,0.01267287,0.0108689,0.00885193,0.00964796,0.0100922,0.00768324,0.00950754,0.0075945,0.00965882,0.01161282,0.00676403,0.00847718,0.01118717,0.00768323,0.00811608,0.00681758,0.00974079,0.00820084,0.00887935,0.0114275,0.01012134,0.01158095,0.00848461,0.01096193,0.00764458,0.01068616,0.01129069,0.00799091,0.01011897,0.01156846,0.00990841,0.01321861,0.00982562,0.01107938,0.01226805,0.01461748,0.01642554,0.01606275,0.01776462,0.01914119,0.01573491,0.01913691,0.01976526,0.02230546,0.0220457,0.02473042,0.02623792,0.02796296,0.02959897,0.0329873,0.03885072,0.04027025,0.04642024,0.05123013,0.05596033,0.06220449,0.06964682,0.07765833,0.08194531,0.09346696,0.09933838,0.10634585,0.11178967,0.1186717,0.11842801,0.12035754,0.11739332,0.1112683,0.10331505,0.09606698,0.08664639,0.07648234,0.07337209,0.06282661,0.05937546,0.05243323,0.04543637,0.04458185,0.03780744,0.03376948,0.03064963,0.03124796,0.02439857,0.02588548,0.02244668,0.02059029,0.01836017,0.01663082,0.01748182,0.01594043,0.01628439,0.01441477,0.01472025,0.01065569,0.01044287,0.01315111,0.01242488,0.01122648,0.00850644,0.0084598,0.00995724,0.01062212,0.00926592,0.00979148,0.00611591,0.0058698,0.00758564,0.00549493,0.00851634,0.00754885,0.00322319,0.00706412,0.00376959,0.00463312,0.00279355,0.00608497,0.00285011,0.00497235,0.00488265,0.00224214,0.00496362,0.00281584,0.00306099,0.00299763,0.00604126,0.00547669,0.0019242,0.00448693,0.00373855,0.00141429,0.00461685,0.00496734,0.00349222,0.00234226,0.00202019,0.00126741,0.0004117,0.00059319,0.00128101,0.00283115,0.0010036,0.00084068,0.00205536,0.0027072,0.00051836,0.00053954,0.00425988,0.00178175,0.00027398,0.00316175,0.00272325,0.00436,-0.00017722,0.00354068,0.00421728,0.00215796,0.00094422,0.00202861,0.00100497,0.00273247,0.00067766,6.602e-05,0.00257366,0.00206884,0.00186432,0.00032829,0.00358086,-0.00053651,-0.00094165,0.00204069,-0.00078937,0.00338288,0.00369088,0.00221734,0.00222376,0.00262407,-0.00084991,0.00060111,0.00011599,0.00231626,0.00127918,0.00352925,0.00217379,-0.00078398,0.00258016,0.00182963,8.07e-06,-0.00036884,0.00125546,0.00200499,-0.00116493,0.00115266,0.0034057,-0.00084842,0.00325528,0.00111761,-0.00014392,0.00047033,0.00076503,0.00121119,0.00208739,-0.00077383,-0.00061302,-0.00121217,0.0022687,-0.00113247,-0.0007569,0.00140031,0.00211216,-0.00036354,0.00227042,0.00037674,0.00306702],
    }
  },

  methods: {

    initializePlot(){

      var graphContainer = this.$refs.graphArea;

      var traceData = {};
      traceData.x = this.xData;
      traceData.y = this.yData;
      traceData.mode = "lines";
      traceData.name = "$y(\\nu_k)$";

      var traceBackground = {};
      traceBackground.x = this.xData;
      traceBackground.y = this.background;
      traceBackground.mode = "lines";
      traceBackground.name = "$B(\\nu_k)$";

      var traceCorrectedSpectrum = {};
      traceCorrectedSpectrum.x = this.xData;
      traceCorrectedSpectrum.y = this.correctedSpectrum;
      traceCorrectedSpectrum.mode = "lines";
      traceCorrectedSpectrum.name = "$S(\\nu_k)$";

      var data = [];
      data.push( traceData );
      data.push( traceBackground );
      data.push( traceCorrectedSpectrum );

      var layout = {};

      layout.xaxis = {};
      layout.xaxis.title = "$$\\Large\\nu$$";
      layout.xaxis.autorange = "reversed";

      layout.legend = {};
      layout.legend.x = 0;
      layout.legend.y = 1;
      layout.legend.font = {};
      layout.legend.font.size = 30;
      layout.legend.itemwidth = 20;
      layout.legend.orientation = "h"

      layout.margin = {};
      layout.margin.t = 40;

      Plotly.newPlot( graphContainer, data, layout);
    },

    updatePlot(){

      if( !this.drawing ){

        this.drawing = true;

        setTimeout(function () {

          this.computeImChi3();

          var graphContainer = this.$refs.graphArea;

          var yUpdate = [];
          yUpdate.push( this.yData );
          yUpdate.push( this.background );
          yUpdate.push( this.correctedSpectrum );

          var update = { y: yUpdate };

          var that = this;

          Plotly.restyle( graphContainer, update)
          .then( function(result) {
            that.drawing = false;
          });
        }.bind(this),0)
      };
    },

    computeBackgroundMatrix(){

      const bgMatrix = lib.computeBackgroundMatrix( this.yData )
      this.backgroundMatrix = bgMatrix;
    },

    computeCorrectedSpectrum(){

      const result = lib.computeResultSpectra( this.yData, this.backgroundMatrix, this.constantValue, this.detailValue);
      this.background = result.background;
      this.correctedSpectrum = result.correctedSpectrum;
    },



  },

  mounted: function() {

    this.config = {
      displaylogo: false,
      responsive: true,
      modeBarButtonsToRemove: ['sendDataToCloud', 'toImage']
    };

    try{

      this.fileData = JSON.parse( JSON.parse( this.inputData ) );
      this.xData = this.fileData.data.x;
      this.yData = this.fileData.data.y;

      this.computeBackgroundMatrix();
      this.computeCorrectedSpectrum();
      this.initializePlot();

    }catch{


      this.computeBackgroundMatrix();
      this.computeCorrectedSpectrum();
      this.initializePlot();

    };
  }
}
</script>
